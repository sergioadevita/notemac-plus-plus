import{u as a,S as B,k as W,l as v,m as ae,n as z,o as ie,p as le,q as ce,s as de,r,t as N,j as e}from"./index-BZEVZHeg.js";import"./react-vendor-P8ZuH1e3.js";import"./monaco-editor-BYMRfcD5.js";async function $(t,s=!1){a.getState().SetGitCredentials(t),s?await B(v,JSON.stringify(t),W*3600):await B(v,JSON.stringify(t),0)}function ue(){a.getState().SetGitCredentials(null),ce(v),de(v)}async function pe(t,s){try{const n=a.getState().gitSettings.corsProxy||z;return await ie.getRemoteInfo({http:le,url:t,corsProxy:n,onAuth:()=>({username:s.username||s.token||"",password:s.token||""})}),{success:!0}}catch(n){return{success:!1,error:n instanceof Error?n.message:String(n)}}}async function xe(){return null}async function he(t){try{const s=await fetch("https://github.com/login/oauth/access_token",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({client_id:ae,device_code:t,grant_type:"urn:ietf:params:oauth:grant-type:device_code"})});if(!s.ok)return null;const n=await s.json();if(n.access_token){const b={type:"oauth",username:"oauth",token:n.access_token};return await $(b,!1),n.access_token}return null}catch{return null}}function fe({theme:t}){const s=a(o=>o.setShowGitSettings),n=a(o=>o.gitCredentials),b=a(o=>o.gitAuthor),k=a(o=>o.gitSettings),_=a(o=>o.browserWorkspaces),[l,L]=r.useState("credentials"),[c,I]=r.useState((n==null?void 0:n.type)||"token"),[h,O]=r.useState((n==null?void 0:n.username)||""),[u,E]=r.useState((n==null?void 0:n.token)||""),[j,M]=r.useState(b.name),[C,V]=r.useState(b.email),[T,J]=r.useState(k.autoFetch),[A,Y]=r.useState(k.corsProxy),[m,q]=r.useState(k.showUntracked),[g,w]=r.useState(null),[y,K]=r.useState(""),[f,X]=r.useState(!1),[R,U]=r.useState(null),[p,x]=r.useState("idle"),[Q,S]=r.useState(""),G=r.useCallback(()=>s(!1),[s]),Z=r.useCallback(async()=>{await $({type:c,username:h,token:u},f)},[c,h,u,f]),ee=r.useCallback(async()=>{try{x("waiting"),S("");const o=await xe();if(o===null){x("error"),S("OAuth not configured. Set VITE_GITHUB_OAUTH_CLIENT_ID or use a Personal Access Token instead.");return}U(o);const H=(o.interval||N)*1e3,se=Math.ceil(o.expiresIn/(o.interval||N));let P=0;const D=async()=>{if(P>=se){x("error"),S("Authorization timed out. Please try again.");return}P++;const F=await he(o.deviceCode);F!==null?(x("success"),E(F),I("oauth"),O("oauth")):p==="waiting"&&setTimeout(D,H)};setTimeout(D,H)}catch{x("error"),S("OAuth authentication failed. Please try again.")}},[p]),te=r.useCallback(()=>{a.getState().SetGitAuthor({name:j,email:C})},[j,C]),oe=r.useCallback(()=>{a.getState().UpdateGitSettings({autoFetch:T,corsProxy:A,showUntracked:m})},[T,A,m]),re=r.useCallback(async()=>{if(!(y.trim().length===0||u.trim().length===0)){w(null);try{const o=await pe(y.trim(),{type:"token",username:h,token:u});w(o)}catch{w({success:!1,error:"Authentication test failed unexpectedly."})}}},[y,h,u]),d={width:"100%",height:30,backgroundColor:t.bgSecondary,color:t.text,border:`1px solid ${t.border}`,borderRadius:4,padding:"0 10px",fontSize:12,boxSizing:"border-box"},i={fontSize:12,color:t.textSecondary,display:"block",marginBottom:4},ne=[{id:"credentials",label:"Credentials"},{id:"author",label:"Author"},{id:"behavior",label:"Behavior"},{id:"workspaces",label:"Workspaces"}];return e.jsx("div",{onClick:G,style:{position:"fixed",inset:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{onClick:o=>o.stopPropagation(),style:{width:500,maxHeight:"80vh",backgroundColor:t.bg,border:`1px solid ${t.border}`,borderRadius:8,boxShadow:"0 8px 32px rgba(0,0,0,0.4)",display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{padding:"12px 16px",borderBottom:`1px solid ${t.border}`,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{style:{fontSize:14,fontWeight:600,color:t.text},children:"Git Settings"}),e.jsx("span",{onClick:G,style:{cursor:"pointer",color:t.textMuted,fontSize:18},children:"âœ•"})]}),e.jsx("div",{style:{display:"flex",borderBottom:`1px solid ${t.border}`},children:ne.map(o=>e.jsx("div",{onClick:()=>L(o.id),style:{padding:"8px 16px",fontSize:12,cursor:"pointer",color:l===o.id?t.accent:t.textSecondary,borderBottom:l===o.id?`2px solid ${t.accent}`:"2px solid transparent",fontWeight:l===o.id?600:400},children:o.label},o.id))}),e.jsxs("div",{style:{padding:16,overflow:"auto",flex:1,display:"flex",flexDirection:"column",gap:12},children:[l==="credentials"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{style:i,children:"Authentication Type"}),e.jsxs("select",{value:c,onChange:o=>I(o.target.value),style:{...d,cursor:"pointer"},children:[e.jsx("option",{value:"token",children:"Personal Access Token (PAT)"}),e.jsx("option",{value:"oauth",children:"OAuth (GitHub)"}),e.jsx("option",{value:"ssh",children:"SSH Key (Electron only)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:i,children:"Username"}),e.jsx("input",{value:h,onChange:o=>O(o.target.value),placeholder:"github-username",style:d})]}),e.jsxs("div",{children:[e.jsx("label",{style:i,children:c==="token"?"Personal Access Token":c==="oauth"?"OAuth Token":"SSH Private Key Path"}),e.jsx("input",{type:"password",value:u,onChange:o=>E(o.target.value),placeholder:c==="ssh"?"~/.ssh/id_rsa":"ghp_xxxx...",style:d})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{fontSize:11,color:t.textMuted,display:"flex",alignItems:"center",gap:6,cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:f,onChange:o=>X(o.target.checked)}),"Remember credentials (encrypted)"]}),f&&e.jsxs("div",{style:{marginTop:4,padding:"4px 8px",borderRadius:4,fontSize:10,backgroundColor:"#f9e2af22",color:"#f9e2af"},children:["Token will be encrypted and stored locally. Expires after ",W," hours."]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{onClick:Z,style:{height:28,padding:"0 12px",backgroundColor:t.accent,color:t.accentText,border:"none",borderRadius:4,fontSize:12,fontWeight:600,cursor:"pointer"},children:"Save Credentials"}),e.jsx("button",{onClick:()=>ue(),style:{height:28,padding:"0 12px",backgroundColor:t.bgHover,color:t.text,border:`1px solid ${t.border}`,borderRadius:4,fontSize:12,cursor:"pointer"},children:"Clear"})]}),c==="oauth"&&e.jsxs("div",{style:{marginTop:8,borderTop:`1px solid ${t.border}`,paddingTop:12},children:[e.jsx("label",{style:i,children:"GitHub OAuth (Device Flow)"}),p==="idle"&&e.jsx("button",{onClick:ee,style:{height:28,padding:"0 12px",backgroundColor:t.bgHover,color:t.text,border:`1px solid ${t.border}`,borderRadius:4,fontSize:12,cursor:"pointer"},children:"Connect with GitHub"}),p==="waiting"&&R!==null&&e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[e.jsx("div",{style:{fontSize:12,color:t.text},children:"Enter this code on GitHub:"}),e.jsx("div",{style:{fontSize:20,fontWeight:700,fontFamily:"monospace",color:t.accent,letterSpacing:4,textAlign:"center",padding:"8px 0",backgroundColor:t.bgSecondary,borderRadius:6},children:R.userCode}),e.jsx("a",{href:R.verificationUri,target:"_blank",rel:"noopener noreferrer",style:{color:t.accent,fontSize:12,textDecoration:"underline"},children:"Open GitHub verification page"}),e.jsx("div",{style:{fontSize:11,color:t.textMuted},children:"Waiting for authorization..."}),e.jsx("button",{onClick:()=>{x("idle"),U(null)},style:{height:24,padding:"0 8px",backgroundColor:t.bgHover,color:t.text,border:`1px solid ${t.border}`,borderRadius:4,fontSize:11,cursor:"pointer",alignSelf:"flex-start"},children:"Cancel"})]}),p==="success"&&e.jsx("div",{style:{padding:"6px 8px",borderRadius:4,fontSize:11,backgroundColor:"#a6e3a122",color:"#a6e3a1"},children:"Connected successfully via GitHub OAuth"}),p==="error"&&e.jsx("div",{style:{padding:"6px 8px",borderRadius:4,fontSize:11,backgroundColor:"#f38ba822",color:"#f38ba8"},children:Q})]}),e.jsxs("div",{style:{marginTop:8,borderTop:`1px solid ${t.border}`,paddingTop:12},children:[e.jsx("label",{style:i,children:"Test Authentication"}),e.jsxs("div",{style:{display:"flex",gap:6},children:[e.jsx("input",{value:y,onChange:o=>K(o.target.value),placeholder:"https://github.com/user/repo.git",style:{...d,flex:1}}),e.jsx("button",{onClick:re,style:{height:30,padding:"0 12px",backgroundColor:t.bgHover,color:t.text,border:`1px solid ${t.border}`,borderRadius:4,fontSize:12,cursor:"pointer",whiteSpace:"nowrap"},children:"Test"})]}),g!==null&&e.jsx("div",{style:{marginTop:6,padding:"6px 8px",borderRadius:4,fontSize:11,backgroundColor:g.success?"#a6e3a122":"#f38ba822",color:g.success?"#a6e3a1":"#f38ba8"},children:g.success?"âœ“ Authentication successful":`âœ• ${g.error}`})]})]}),l==="author"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{style:i,children:"Author Name"}),e.jsx("input",{value:j,onChange:o=>M(o.target.value),placeholder:"Your Name",style:d})]}),e.jsxs("div",{children:[e.jsx("label",{style:i,children:"Author Email"}),e.jsx("input",{value:C,onChange:o=>V(o.target.value),placeholder:"you@example.com",style:d})]}),e.jsx("button",{onClick:te,style:{height:28,padding:"0 12px",backgroundColor:t.accent,color:t.accentText,border:"none",borderRadius:4,fontSize:12,fontWeight:600,cursor:"pointer",alignSelf:"flex-start"},children:"Save Author Info"})]}),l==="behavior"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("input",{type:"checkbox",checked:T,onChange:o=>J(o.target.checked),id:"auto-fetch"}),e.jsx("label",{htmlFor:"auto-fetch",style:{fontSize:12,color:t.text},children:"Auto-fetch from remote (every 5 minutes)"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("input",{type:"checkbox",checked:m,onChange:o=>q(o.target.checked),id:"show-untracked"}),e.jsx("label",{htmlFor:"show-untracked",style:{fontSize:12,color:t.text},children:"Show untracked files"})]}),e.jsxs("div",{children:[e.jsx("label",{style:i,children:"CORS Proxy URL"}),e.jsx("input",{value:A,onChange:o=>Y(o.target.value),placeholder:z,style:d}),e.jsxs("div",{style:{fontSize:10,color:t.textMuted,marginTop:4},children:["Required for web-based git operations. Default: ",z]})]}),e.jsx("button",{onClick:oe,style:{height:28,padding:"0 12px",backgroundColor:t.accent,color:t.accentText,border:"none",borderRadius:4,fontSize:12,fontWeight:600,cursor:"pointer",alignSelf:"flex-start"},children:"Save Settings"})]}),l==="workspaces"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{fontSize:12,color:t.textSecondary,marginBottom:4},children:"Browser workspaces are stored in IndexedDB. They are only available in this browser."}),_.length===0?e.jsx("div",{style:{color:t.textMuted,fontSize:12,padding:8,textAlign:"center"},children:"No browser workspaces"}):_.map(o=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,padding:"6px 8px",borderRadius:4,border:`1px solid ${t.border}`},children:[e.jsx("span",{style:{fontSize:14},children:"ðŸ“"}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontSize:12,color:t.text,fontWeight:600},children:o.name}),o.repoUrl&&e.jsx("div",{style:{fontSize:10,color:t.textMuted},children:o.repoUrl}),e.jsxs("div",{style:{fontSize:10,color:t.textMuted},children:["Last opened: ",new Date(o.lastOpenedAt).toLocaleDateString()]})]}),e.jsx("button",{onClick:()=>a.getState().RemoveBrowserWorkspace(o.id),style:{height:22,padding:"0 8px",backgroundColor:"#f38ba822",color:"#f38ba8",border:"none",borderRadius:3,fontSize:10,cursor:"pointer"},children:"Delete"})]},o.id))]})]})]})})}export{fe as GitSettingsViewPresenter};
