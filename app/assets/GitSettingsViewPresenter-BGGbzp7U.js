import{u as i,S as N,l as $,m as j,G as ae,n as _,o as le,p as ce,q as de,s as ue,r,t as W,j as e}from"./index-BxO2YTdS.js";import"./react-vendor-P8ZuH1e3.js";import"./monaco-editor-C1KnpKkb.js";async function L(t,s=!1){i.getState().SetGitCredentials(t),s?await N(j,JSON.stringify(t),$*3600):await N(j,JSON.stringify(t),0)}function pe(){i.getState().SetGitCredentials(null),de(j),ue(j)}async function xe(t,s){try{const n=i.getState().gitSettings.corsProxy||_;return await le.getRemoteInfo({http:ce,url:t,corsProxy:n,onAuth:()=>({username:s.username||s.token||"",password:s.token||""})}),{success:!0}}catch(n){return{success:!1,error:n instanceof Error?n.message:String(n)}}}async function he(){return null}async function ge(t){try{const s=await fetch("https://github.com/login/oauth/access_token",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({client_id:ae,device_code:t,grant_type:"urn:ietf:params:oauth:grant-type:device_code"})});if(!s.ok)return null;const n=await s.json();if(n.access_token){const y={type:"oauth",username:"oauth",token:n.access_token};return await L(y,!1),n.access_token}return null}catch{return null}}function Se({theme:t}){const s=i(o=>o.setShowGitSettings),n=i(o=>o.gitCredentials),y=i(o=>o.gitAuthor),k=i(o=>o.gitSettings),I=i(o=>o.browserWorkspaces),[l,M]=r.useState("credentials"),[c,O]=r.useState((n==null?void 0:n.type)||"token"),[h,E]=r.useState((n==null?void 0:n.username)||""),[u,G]=r.useState((n==null?void 0:n.token)||""),[C,V]=r.useState(y.name),[T,J]=r.useState(y.email),[A,Y]=r.useState(k.autoFetch),[m,q]=r.useState(k.corsProxy),[w,K]=r.useState(k.showUntracked),[g,R]=r.useState(null),[f,X]=r.useState(""),[S,Q]=r.useState(!1),[z,U]=r.useState(null),[p,x]=r.useState("idle"),[Z,v]=r.useState(""),b=r.useRef(null),H=r.useCallback(()=>s(!1),[s]),ee=r.useCallback(async()=>{await L({type:c,username:h,token:u},S)},[c,h,u,S]),te=r.useCallback(async()=>{try{x("waiting"),v("");const o=await he();if(o===null){x("error"),v("OAuth not configured. Set VITE_GITHUB_OAUTH_CLIENT_ID or use a Personal Access Token instead.");return}U(o);const P=(o.interval||W)*1e3,ie=Math.ceil(o.expiresIn/(o.interval||W));let D=0;const F=async()=>{if(D>=ie){x("error"),v("Authorization timed out. Please try again.");return}D++;const B=await ge(o.deviceCode);B!==null?(x("success"),G(B),O("oauth"),E("oauth")):p==="waiting"&&(b.current=setTimeout(F,P))};b.current=setTimeout(F,P)}catch{x("error"),v("OAuth authentication failed. Please try again.")}},[p]),oe=r.useCallback(()=>{i.getState().SetGitAuthor({name:C,email:T})},[C,T]),re=r.useCallback(()=>{i.getState().UpdateGitSettings({autoFetch:A,corsProxy:m,showUntracked:w})},[A,m,w]),ne=r.useCallback(async()=>{if(!(f.trim().length===0||u.trim().length===0)){R(null);try{const o=await xe(f.trim(),{type:"token",username:h,token:u});R(o)}catch{R({success:!1,error:"Authentication test failed unexpectedly."})}}},[f,h,u]);r.useEffect(()=>()=>{b.current&&(clearTimeout(b.current),b.current=null)},[]);const d={width:"100%",height:30,backgroundColor:t.bgSecondary,color:t.text,border:`1px solid ${t.border}`,borderRadius:4,padding:"0 10px",fontSize:12,boxSizing:"border-box"},a={fontSize:12,color:t.textSecondary,display:"block",marginBottom:4},se=[{id:"credentials",label:"Credentials"},{id:"author",label:"Author"},{id:"behavior",label:"Behavior"},{id:"workspaces",label:"Workspaces"}];return e.jsx("div",{onClick:H,style:{position:"fixed",inset:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{onClick:o=>o.stopPropagation(),style:{width:500,maxHeight:"80vh",backgroundColor:t.bg,border:`1px solid ${t.border}`,borderRadius:8,boxShadow:"0 8px 32px rgba(0,0,0,0.4)",display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{padding:"12px 16px",borderBottom:`1px solid ${t.border}`,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{style:{fontSize:14,fontWeight:600,color:t.text},children:"Git Settings"}),e.jsx("span",{onClick:H,style:{cursor:"pointer",color:t.textMuted,fontSize:18},children:"âœ•"})]}),e.jsx("div",{style:{display:"flex",borderBottom:`1px solid ${t.border}`},children:se.map(o=>e.jsx("div",{onClick:()=>M(o.id),style:{padding:"8px 16px",fontSize:12,cursor:"pointer",color:l===o.id?t.accent:t.textSecondary,borderBottom:l===o.id?`2px solid ${t.accent}`:"2px solid transparent",fontWeight:l===o.id?600:400},children:o.label},o.id))}),e.jsxs("div",{style:{padding:16,overflow:"auto",flex:1,display:"flex",flexDirection:"column",gap:12},children:[l==="credentials"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{style:a,children:"Authentication Type"}),e.jsxs("select",{value:c,onChange:o=>O(o.target.value),style:{...d,cursor:"pointer"},children:[e.jsx("option",{value:"token",children:"Personal Access Token (PAT)"}),e.jsx("option",{value:"oauth",children:"OAuth (GitHub)"}),e.jsx("option",{value:"ssh",children:"SSH Key (Electron only)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:a,children:"Username"}),e.jsx("input",{value:h,onChange:o=>E(o.target.value),placeholder:"github-username",style:d})]}),e.jsxs("div",{children:[e.jsx("label",{style:a,children:c==="token"?"Personal Access Token":c==="oauth"?"OAuth Token":"SSH Private Key Path"}),e.jsx("input",{type:"password",value:u,onChange:o=>G(o.target.value),placeholder:c==="ssh"?"~/.ssh/id_rsa":"ghp_xxxx...",style:d})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{fontSize:11,color:t.textMuted,display:"flex",alignItems:"center",gap:6,cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:S,onChange:o=>Q(o.target.checked)}),"Remember credentials (encrypted)"]}),S&&e.jsxs("div",{style:{marginTop:4,padding:"4px 8px",borderRadius:4,fontSize:10,backgroundColor:"#f9e2af22",color:"#f9e2af"},children:["Token will be encrypted and stored locally. Expires after ",$," hours."]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{onClick:ee,style:{height:28,padding:"0 12px",backgroundColor:t.accent,color:t.accentText,border:"none",borderRadius:4,fontSize:12,fontWeight:600,cursor:"pointer"},children:"Save Credentials"}),e.jsx("button",{onClick:()=>pe(),style:{height:28,padding:"0 12px",backgroundColor:t.bgHover,color:t.text,border:`1px solid ${t.border}`,borderRadius:4,fontSize:12,cursor:"pointer"},children:"Clear"})]}),c==="oauth"&&e.jsxs("div",{style:{marginTop:8,borderTop:`1px solid ${t.border}`,paddingTop:12},children:[e.jsx("label",{style:a,children:"GitHub OAuth (Device Flow)"}),p==="idle"&&e.jsx("button",{onClick:te,style:{height:28,padding:"0 12px",backgroundColor:t.bgHover,color:t.text,border:`1px solid ${t.border}`,borderRadius:4,fontSize:12,cursor:"pointer"},children:"Connect with GitHub"}),p==="waiting"&&z!==null&&e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[e.jsx("div",{style:{fontSize:12,color:t.text},children:"Enter this code on GitHub:"}),e.jsx("div",{style:{fontSize:20,fontWeight:700,fontFamily:"monospace",color:t.accent,letterSpacing:4,textAlign:"center",padding:"8px 0",backgroundColor:t.bgSecondary,borderRadius:6},children:z.userCode}),e.jsx("a",{href:z.verificationUri,target:"_blank",rel:"noopener noreferrer",style:{color:t.accent,fontSize:12,textDecoration:"underline"},children:"Open GitHub verification page"}),e.jsx("div",{style:{fontSize:11,color:t.textMuted},children:"Waiting for authorization..."}),e.jsx("button",{onClick:()=>{x("idle"),U(null)},style:{height:24,padding:"0 8px",backgroundColor:t.bgHover,color:t.text,border:`1px solid ${t.border}`,borderRadius:4,fontSize:11,cursor:"pointer",alignSelf:"flex-start"},children:"Cancel"})]}),p==="success"&&e.jsx("div",{style:{padding:"6px 8px",borderRadius:4,fontSize:11,backgroundColor:"#a6e3a122",color:"#a6e3a1"},children:"Connected successfully via GitHub OAuth"}),p==="error"&&e.jsx("div",{style:{padding:"6px 8px",borderRadius:4,fontSize:11,backgroundColor:"#f38ba822",color:"#f38ba8"},children:Z})]}),e.jsxs("div",{style:{marginTop:8,borderTop:`1px solid ${t.border}`,paddingTop:12},children:[e.jsx("label",{style:a,children:"Test Authentication"}),e.jsxs("div",{style:{display:"flex",gap:6},children:[e.jsx("input",{value:f,onChange:o=>X(o.target.value),placeholder:"https://github.com/user/repo.git",style:{...d,flex:1}}),e.jsx("button",{onClick:ne,style:{height:30,padding:"0 12px",backgroundColor:t.bgHover,color:t.text,border:`1px solid ${t.border}`,borderRadius:4,fontSize:12,cursor:"pointer",whiteSpace:"nowrap"},children:"Test"})]}),g!==null&&e.jsx("div",{style:{marginTop:6,padding:"6px 8px",borderRadius:4,fontSize:11,backgroundColor:g.success?"#a6e3a122":"#f38ba822",color:g.success?"#a6e3a1":"#f38ba8"},children:g.success?"âœ“ Authentication successful":`âœ• ${g.error}`})]})]}),l==="author"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{style:a,children:"Author Name"}),e.jsx("input",{value:C,onChange:o=>V(o.target.value),placeholder:"Your Name",style:d})]}),e.jsxs("div",{children:[e.jsx("label",{style:a,children:"Author Email"}),e.jsx("input",{value:T,onChange:o=>J(o.target.value),placeholder:"you@example.com",style:d})]}),e.jsx("button",{onClick:oe,style:{height:28,padding:"0 12px",backgroundColor:t.accent,color:t.accentText,border:"none",borderRadius:4,fontSize:12,fontWeight:600,cursor:"pointer",alignSelf:"flex-start"},children:"Save Author Info"})]}),l==="behavior"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("input",{type:"checkbox",checked:A,onChange:o=>Y(o.target.checked),id:"auto-fetch"}),e.jsx("label",{htmlFor:"auto-fetch",style:{fontSize:12,color:t.text},children:"Auto-fetch from remote (every 5 minutes)"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("input",{type:"checkbox",checked:w,onChange:o=>K(o.target.checked),id:"show-untracked"}),e.jsx("label",{htmlFor:"show-untracked",style:{fontSize:12,color:t.text},children:"Show untracked files"})]}),e.jsxs("div",{children:[e.jsx("label",{style:a,children:"CORS Proxy URL"}),e.jsx("input",{value:m,onChange:o=>q(o.target.value),placeholder:_,style:d}),e.jsxs("div",{style:{fontSize:10,color:t.textMuted,marginTop:4},children:["Required for web-based git operations. Default: ",_]})]}),e.jsx("button",{onClick:re,style:{height:28,padding:"0 12px",backgroundColor:t.accent,color:t.accentText,border:"none",borderRadius:4,fontSize:12,fontWeight:600,cursor:"pointer",alignSelf:"flex-start"},children:"Save Settings"})]}),l==="workspaces"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{fontSize:12,color:t.textSecondary,marginBottom:4},children:"Browser workspaces are stored in IndexedDB. They are only available in this browser."}),I.length===0?e.jsx("div",{style:{color:t.textMuted,fontSize:12,padding:8,textAlign:"center"},children:"No browser workspaces"}):I.map(o=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,padding:"6px 8px",borderRadius:4,border:`1px solid ${t.border}`},children:[e.jsx("span",{style:{fontSize:14},children:"ðŸ“"}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontSize:12,color:t.text,fontWeight:600},children:o.name}),o.repoUrl&&e.jsx("div",{style:{fontSize:10,color:t.textMuted},children:o.repoUrl}),e.jsxs("div",{style:{fontSize:10,color:t.textMuted},children:["Last opened: ",new Date(o.lastOpenedAt).toLocaleDateString()]})]}),e.jsx("button",{onClick:()=>i.getState().RemoveBrowserWorkspace(o.id),style:{height:22,padding:"0 8px",backgroundColor:"#f38ba822",color:"#f38ba8",border:"none",borderRadius:3,fontSize:10,cursor:"pointer"},children:"Delete"})]},o.id))]})]})]})})}export{Se as GitSettingsViewPresenter};
